networks:

  traefik:
    external: true

  paperlessngx:


services:

  paperlessngx:

    container_name: paperlessngx
    hostname: paperlessngx

    # https://hub.docker.com/r/paperlessngx/paperless-ngx/tags
    image: paperlessngx/paperless-ngx:1.17.1

    depends_on:

      paperlessngx-redis:
        condition: service_healthy
        restart: true

      paperlessngx-db:
        condition: service_healthy
        restart: true

    networks:
      - traefik
      - paperlessngx

    labels:

      # traefik
      - traefik.enable=true
      - traefik.http.routers.paperlessngx.rule=Host(`paperlessngx.stb.de`)
      - traefik.http.services.paperlessngx.loadbalancer.server.port=8000

      - traefik.http.routers.paperlessngx.tls.certresolver=stbde
      - traefik.http.routers.paperlessngx.tls.domains[0].main=paperlessngx.stb.de
      - traefik.http.routers.paperlessngx.tls.domains[0].sans=*.paperlessngx.stb.de


      # homepage
      - homepage.group=paperlessngx (.stb.de)
      - homepage.name=paperlessngx (paperlessngx.stb.de)
      - homepage.weight=-999
      - homepage.description=paperlessngx/paperless-ngx
      - homepage.showStats=true
      - homepage.icon=paperless.png
      - homepage.href=https://paperlessngx.stb.de
      - homepage.ping=https://paperlessngx.stb.de

    restart: unless-stopped

    env_file: ./env/paperlessngx.env

    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./volumes/paperless/consume:/usr/src/paperless/consume
      - ./volumes/paperless/data:/usr/src/paperless/data
      - ./volumes/paperless/export:/usr/src/paperless/export
      - ./volumes/paperless/media:/usr/src/paperless/media

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3


  paperlessngx-redis:

    container_name: paperlessngx-redis
    hostname: paperlessngx-redis

    image: redis:7.2.0-alpine3.18

    depends_on:

      paperlessngx-db:
        condition: service_healthy
        restart: true

    networks:
      - paperlessngx

    labels:

      # homepage
      - homepage.group=paperlessngx (.stb.de)
      - homepage.name=paperlessngx-redis
      - homepage.description=redis:7-alpine
      - homepage.showStats=true
      - homepage.icon=redis.png

    restart: unless-stopped

    volumes:
      - /etc/localtime:/etc/localtime:ro

    healthcheck:
      test: redis-cli ping | grep PONG -q
      timeout: 5s
      interval: 15s
      start_period: 30s
      retries: 3


  paperlessngx-db:

    container_name: paperlessngx-db
    hostname: paperlessngx-db

    # PaperlessNGX: 10.11.5-jammy
    # https://hub.docker.com/_/mariadb/tags
    image: mariadb:10.11.5-jammy

    networks:
      - paperlessngx

    labels:

      # homepage
      - homepage.group=paperlessngx (.stb.de)
      - homepage.name=paperlessngx-db
      - homepage.description=mariadb:10
      - homepage.showStats=true
      - homepage.icon=mariadb.png

    env_file:
      - ./env/db.env

    restart: unless-stopped

    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./volumes/db:/var/lib/mysql

    healthcheck:
      test: healthcheck.sh --su-mysql --connect --innodb_initialized
      timeout: 5s
      interval: 15s
      start_period: 60s
      retries: 3
